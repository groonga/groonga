#@require-env GRN_LANGUAGE_MODEL_DOWNLOAD_CACHE_DIR
#@require-feature llama.cpp

#@on-error omit
plugin_register language_model/knn
#@on-error default

table_create Data TABLE_NO_KEY
column_create Data text COLUMN_SCALAR ShortText
column_create Data rabitq_code COLUMN_SCALAR ShortBinary

load --table Data
[
{"text": "I am a boy."},
{"text": "I am a man."},
{"text": "This is my home."},
{"text": "This is my car."},
{"text": "This is an apple."},
{"text": "Groonga is an open-source fulltext search engine."},
{"text": "I like Ruby."},
{"text": "This computer is fast."},
{"text": "This is a pen."},
{"text": "This is a tulip."},
{"text": "This is a onion."}
]

table_create RaBitQ TABLE_HASH_KEY ShortBinary \
  --default_tokenizer \
    'TokenLanguageModelKNN("model", "hf:///groonga/multilingual-e5-base-Q4_K_M-GGUF", \
                           "code_column", "rabitq_code", \
                           "passage_prefix", "passage: ", \
                           "query_prefix", "query: ")'
# This is for waiting for downloading model.
#@timeout 300
#@read-timeout 300
column_create RaBitQ data_text COLUMN_INDEX Data text

select Data \
  --filter 'language_model_knn(text, "male child", { "k" : -1 })' \
  --output_columns text
