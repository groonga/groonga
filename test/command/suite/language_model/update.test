#@omit "TODO: This doesn't work on GitHub Actions"

#@require-env GRN_LANGUAGE_MODEL_DOWNLOAD_CACHE_DIR
#@require-feature llama.cpp

#@on-error omit
plugin_register language_model/knn
#@on-error default

table_create Data TABLE_NO_KEY
column_create Data text COLUMN_SCALAR ShortText
column_create Data rabitq_code COLUMN_SCALAR ShortBinary

load --table Data
[
{"text": "I am a king."},
{"text": "I am a queen."}
]

table_create RaBitQ TABLE_HASH_KEY ShortBinary \
  --default_tokenizer 'TokenLanguageModel("model", "hf:///groonga/all-MiniLM-L6-v2-Q4_K_M-GGUF", \
                                          "code_column", "rabitq_code")'
column_create RaBitQ data_text COLUMN_INDEX Data text

load --table Data
[
{"text": "I am a dog."}
]

select Data \
  --filter 'language_model_knn(text, "pet", 10)' \
  --sort_keys -_score \
  --output_columns text
